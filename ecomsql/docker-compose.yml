services:
  # Nginx reverse proxy (main entry point)
  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
    container_name: ecommerce-nginx
    ports:
      - "80:80"
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 32M
    depends_on:
      - client
      - server
    networks:
      - ecommerce-network
    restart: on-failure

  # Frontend application (served through nginx)
  client:
    build:
      context: ./client
      dockerfile: Dockerfile.alpine
    container_name: ecommerce-client
    ports:
      - "3002:3002"
    environment:
      # API URL for the client - served through nginx
      # http://localhost/api gets proxied to server:5002/api
      - REACT_APP_API_URL=${REACT_APP_API_URL:-http://localhost/api}
      - PORT=3002
    expose:
      - 3002
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 124M
    depends_on:
      - server
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./app.conf:/etc/nginx/conf.d/app.conf
    networks:
      - ecommerce-network
    restart: on-failure

  # Backend API server (served through nginx)
  server:
    build:
      context: ./server
      dockerfile: Dockerfile.alpine
    container_name: ecommerce-server
    environment:
      - NODE_ENV=production
      - PORT=5002
      - CLIENT_URL=http://localhost
      # Database configuration - Update these with your database details
      - DB_SERVER=${DB_SERVER:-gnanabi.database.windows.net}
      - DB_NAME=${DB_NAME:-ecommerce}
      - DB_USER=${DB_USER:-servergnanaabi}
      - DB_PASSWORD=${DB_PASSWORD:-serverpassword@123}
      - DB_PORT=${DB_PORT:-1433}
    volumes:
      - ./server/uploads:/app/uploads
    ports:
      - "5002:5002"
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 124M
    networks:
      - ecommerce-network
    restart: on-failure
networks:
  ecommerce-network:
    driver: bridge

volumes:
  server-uploads:
    driver: local
